name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@7eaf76671a0d7eec5d98ee897acda4f968735a17
        with:
          host: ${{ secrets.OCI_VM_HOST }}
          username: ${{ secrets.OCI_VM_USER }}
          key: ${{ secrets.OCI_SSH_PRIVATE_KEY }}
          port: 22
          script_stop: true
          script: |
            set -euo pipefail

            export NVM_DIR="$HOME/.nvm"
            if [ -s "$NVM_DIR/nvm.sh" ]; then
              . "$NVM_DIR/nvm.sh"
            fi

            APP_DIR="${{ secrets.DEPLOY_DIR }}"
            if [ -z "$APP_DIR" ]; then APP_DIR="/opt/boj-mock-web"; fi

            DEPLOY_BRANCH="${{ secrets.DEPLOY_BRANCH }}"
            if [ -z "$DEPLOY_BRANCH" ]; then DEPLOY_BRANCH="main"; fi

            APP_SERVICE_NAME="${{ secrets.APP_SERVICE_NAME }}"
            if [ -z "$APP_SERVICE_NAME" ]; then APP_SERVICE_NAME="boj-mock"; fi

            # Prevent concurrent deploys on the same VM.
            exec 9>/tmp/boj-mock-deploy.lock
            if ! flock -n 9; then
              echo "deploy lock busy; another deploy is running" >&2
              exit 1
            fi

            cd "$APP_DIR"
            git fetch origin "$DEPLOY_BRANCH"
            git checkout "$DEPLOY_BRANCH"
            git pull --ff-only origin "$DEPLOY_BRANCH"

            # Stop service so dependencies aren't being used while we replace them.
            sudo systemctl stop "$APP_SERVICE_NAME" || true

            # npm ci occasionally fails with ENOTEMPTY during cleanup on servers.
            # Remove node_modules upfront to avoid rmdir races.
            rm -rf node_modules web/node_modules server/node_modules

            npm ci --no-audit --no-fund
            npm --prefix web run build

            mkdir -p /tmp/boj-mock-run
            node server/scripts/runner-init.js

            sudo systemctl restart "$APP_SERVICE_NAME"
            if ! sudo systemctl is-active --quiet "$APP_SERVICE_NAME"; then
              echo "service failed to start: $APP_SERVICE_NAME" >&2
              sudo systemctl status "$APP_SERVICE_NAME" --no-pager || true
              sudo journalctl -u "$APP_SERVICE_NAME" -n 200 --no-pager || true
              exit 1
            fi

            # Wait for the server to bind the port before failing the deploy.
            ok=0
            for i in $(seq 1 30); do
              if curl -fs http://127.0.0.1:5179/api/health >/dev/null 2>&1; then
                ok=1
                break
              fi
              sleep 1
            done

            if [ "$ok" -ne 1 ]; then
              echo "healthcheck failed: /api/health not reachable on 127.0.0.1:5179" >&2
              sudo systemctl status "$APP_SERVICE_NAME" --no-pager || true
              sudo journalctl -u "$APP_SERVICE_NAME" -n 120 --no-pager || true
              curl -fsS http://127.0.0.1:5179/api/health || true
              exit 1
            fi
