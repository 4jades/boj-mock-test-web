name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.OCI_VM_HOST }}
          username: ${{ secrets.OCI_VM_USER }}
          key: ${{ secrets.OCI_SSH_PRIVATE_KEY }}
          port: 22
          script_stop: true
          script: |
            set -euo pipefail

            export NVM_DIR="$HOME/.nvm"
            if [ -s "$NVM_DIR/nvm.sh" ]; then
              . "$NVM_DIR/nvm.sh"
            fi

            APP_DIR="${{ secrets.DEPLOY_DIR }}"
            if [ -z "$APP_DIR" ]; then APP_DIR="/opt/boj-mock-web"; fi

            DEPLOY_BRANCH="${{ secrets.DEPLOY_BRANCH }}"
            if [ -z "$DEPLOY_BRANCH" ]; then DEPLOY_BRANCH="main"; fi

            APP_SERVICE_NAME="${{ secrets.APP_SERVICE_NAME }}"
            if [ -z "$APP_SERVICE_NAME" ]; then APP_SERVICE_NAME="boj-mock"; fi

            cd "$APP_DIR"
            git fetch origin "$DEPLOY_BRANCH"
            git checkout "$DEPLOY_BRANCH"
            git pull --ff-only origin "$DEPLOY_BRANCH"

            npm --prefix web ci
            npm --prefix web run build
            npm --prefix server ci

            mkdir -p /tmp/boj-mock-run
            node server/scripts/runner-init.js

            sudo systemctl restart "$APP_SERVICE_NAME"
            sudo systemctl is-active --quiet "$APP_SERVICE_NAME"
            curl -fsS http://127.0.0.1:5179/api/health
